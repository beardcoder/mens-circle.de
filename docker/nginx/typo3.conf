# =============================================================================
# TYPO3 v14 Nginx Configuration
# Only TYPO3-specific routing - other settings handled by serversideup/php
# =============================================================================

# TYPO3 Frontend
location / {
    try_files $uri $uri/ /index.php$is_args$args;
}

# TYPO3 Backend
location /typo3 {
    try_files $uri $uri/ /typo3/index.php$is_args$args;
}

# API routes (middleware)
location ~ ^/(api|newsletter)/ {
    try_files $uri /index.php$is_args$args;
}

# Static file caching (extends base config)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
    try_files $uri =404;
}

# TYPO3 typo3temp/fileadmin caching
location ~ ^/(typo3temp/assets|fileadmin) {
    expires 1M;
    add_header Cache-Control "public";
    try_files $uri =404;
}

# Security: Deny access to sensitive files
location ~ /\. {
    deny all;
}

location ~ ^/(typo3conf|typo3temp|uploads)/.*\.php$ {
    deny all;
}

location ~ ^/(config|packages|vendor|var)/ {
    deny all;
}

location ~ /(composer\.(json|lock)|package(-lock)?\.json)$ {
    deny all;
}
