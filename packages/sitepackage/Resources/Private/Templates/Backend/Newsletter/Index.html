<html
    xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
    xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
    data-namespace-typo3-fluid="true"
>
<f:layout name="Module" />

<f:section name="Before">
    <f:be.pageRenderer
        includeJavaScriptModules="{
            0: '@typo3/backend/context-menu.js'
        }"
    />
</f:section>

<f:section name="Content">
    <div class="row">
        <div class="col-md-3">
            <div class="card card-default mb-4">
                <div class="card-header">
                    <h3 class="card-title">Subscribers</h3>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col">
                            <h2 class="text-success">{subscriberStats.confirmed}</h2>
                            <small class="text-muted">Active</small>
                        </div>
                        <div class="col">
                            <h2 class="text-warning">{subscriberStats.pending}</h2>
                            <small class="text-muted">Pending</small>
                        </div>
                        <div class="col">
                            <h2 class="text-secondary">{subscriberStats.unsubscribed}</h2>
                            <small class="text-muted">Unsubscribed</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <f:link.action action="subscribers" class="btn btn-sm btn-default">
                        View All Subscribers
                    </f:link.action>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card card-default">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Newsletters</h3>
                        <f:link.action action="create" class="btn btn-primary btn-sm">
                            <core:icon identifier="actions-plus" /> Create Newsletter
                        </f:link.action>
                    </div>
                </div>
                <div class="card-body p-0">
                    <f:if condition="{newsletters -> f:count()} > 0">
                        <f:then>
                            <table class="table table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Recipients</th>
                                        <th>Sent</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <f:for each="{newsletters}" as="newsletter">
                                        <tr>
                                            <td>
                                                <f:link.action action="edit" arguments="{newsletter: newsletter}">
                                                    {newsletter.subject}
                                                </f:link.action>
                                            </td>
                                            <td>
                                                <f:switch expression="{newsletter.status.value}">
                                                    <f:case value="0">
                                                        <span class="badge bg-secondary">Draft</span>
                                                    </f:case>
                                                    <f:case value="1">
                                                        <span class="badge bg-info">Scheduled</span>
                                                    </f:case>
                                                    <f:case value="2">
                                                        <span class="badge bg-warning">Sending</span>
                                                    </f:case>
                                                    <f:case value="3">
                                                        <span class="badge bg-success">Sent</span>
                                                    </f:case>
                                                    <f:case value="4">
                                                        <span class="badge bg-danger">Failed</span>
                                                    </f:case>
                                                </f:switch>
                                            </td>
                                            <td>{newsletter.recipientsCount}</td>
                                            <td>
                                                <f:if condition="{newsletter.sentAt}">
                                                    <f:format.date format="d.m.Y H:i">{newsletter.sentAt}</f:format.date>
                                                </f:if>
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm">
                                                    <f:link.action action="edit" arguments="{newsletter: newsletter}" class="btn btn-default">
                                                        <core:icon identifier="actions-open" />
                                                    </f:link.action>
                                                    <f:if condition="{newsletter.canSend()}">
                                                        <f:form action="send" method="post" arguments="{newsletter: newsletter}" style="display: inline;">
                                                            <button type="submit" class="btn btn-success" onclick="return confirm('Send this newsletter to all active subscribers?')">
                                                                <core:icon identifier="actions-envelope" /> Send
                                                            </button>
                                                        </f:form>
                                                    </f:if>
                                                    <f:if condition="{newsletter.canEdit()}">
                                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{newsletter.uid}">
                                                            <core:icon identifier="actions-delete" />
                                                        </button>
                                                    </f:if>
                                                </div>

                                                <!-- Delete Modal -->
                                                <div class="modal fade" id="deleteModal{newsletter.uid}" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Delete Newsletter</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                Are you sure you want to delete "{newsletter.subject}"?
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                <f:form action="delete" method="post" arguments="{newsletter: newsletter}">
                                                                    <button type="submit" class="btn btn-danger">Delete</button>
                                                                </f:form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </f:for>
                                </tbody>
                            </table>
                        </f:then>
                        <f:else>
                            <div class="callout callout-info">
                                <p>No newsletters yet. Create your first newsletter to get started.</p>
                            </div>
                        </f:else>
                    </f:if>
                </div>
            </div>
        </div>
    </div>
</f:section>
