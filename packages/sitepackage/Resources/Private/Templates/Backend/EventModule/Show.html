<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module" />

<f:section name="Content">
    <div class="module-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{event.title}</h1>
            <div>
                <f:link.action action="list" class="btn btn-secondary">
                    Zurück zur Liste
                </f:link.action>
                <be:link.editRecord uid="{event.uid}" table="tx_sitepackage_domain_model_event" class="btn btn-warning">
                    Bearbeiten
                </be:link.editRecord>
                <f:link.action action="exportRegistrations" arguments="{event: event}" class="btn btn-primary">
                    CSV Export
                </f:link.action>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Event Details</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Datum</dt>
                            <dd class="col-sm-8">
                                <f:format.date format="d.m.Y">{event.eventDate}</f:format.date>
                            </dd>

                            <dt class="col-sm-4">Uhrzeit</dt>
                            <dd class="col-sm-8">
                                {event.startTimeFormatted} - {event.endTimeFormatted} Uhr
                            </dd>

                            <dt class="col-sm-4">Ort</dt>
                            <dd class="col-sm-8">
                                {event.location}
                                <f:if condition="{event.fullAddress}">
                                    <br><small class="text-muted">{event.fullAddress}</small>
                                </f:if>
                            </dd>

                            <dt class="col-sm-4">Kosten</dt>
                            <dd class="col-sm-8">{event.costBasis}</dd>

                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8">
                                <f:if condition="{event.isPublished}">
                                    <f:then>
                                        <span class="badge bg-success">Veröffentlicht</span>
                                    </f:then>
                                    <f:else>
                                        <span class="badge bg-secondary">Entwurf</span>
                                    </f:else>
                                </f:if>
                                <f:if condition="{event.isPast}">
                                    <span class="badge bg-warning">Vergangen</span>
                                </f:if>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Anmeldungen</h3>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="display-6">{confirmedCount}</div>
                                <div class="text-muted">Bestätigt</div>
                            </div>
                            <div class="col-4">
                                <div class="display-6">{event.maxParticipants}</div>
                                <div class="text-muted">Max.</div>
                            </div>
                            <div class="col-4">
                                <div class="display-6 {f:if(condition: '{availableSpots} == 0', then: 'text-danger', else: 'text-success')}">{availableSpots}</div>
                                <div class="text-muted">Frei</div>
                            </div>
                        </div>
                        <div class="progress mt-3" style="height: 20px;">
                            <f:variable name="percentage" value="{confirmedCount / event.maxParticipants * 100}" />
                            <div class="progress-bar {f:if(condition: '{availableSpots} == 0', then: 'bg-danger', else: 'bg-success')}"
                                 role="progressbar"
                                 style="width: {percentage}%"
                                 aria-valuenow="{confirmedCount}"
                                 aria-valuemin="0"
                                 aria-valuemax="{event.maxParticipants}">
                                {confirmedCount} / {event.maxParticipants}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Anmeldungsliste</h3>
                <span class="badge bg-primary">{registrations -> f:count()} Anmeldungen</span>
            </div>
            <div class="card-body">
                <f:if condition="{registrations -> f:count()} > 0">
                    <f:then>
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>E-Mail</th>
                                    <th>Telefon</th>
                                    <th>Status</th>
                                    <th>Angemeldet am</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <f:for each="{registrations}" as="registration" iteration="i">
                                    <tr>
                                        <td>{i.cycle}</td>
                                        <td>
                                            <strong>{registration.fullName}</strong>
                                        </td>
                                        <td>
                                            <a href="mailto:{registration.email}">{registration.email}</a>
                                        </td>
                                        <td>
                                            <f:if condition="{registration.phoneNumber}">
                                                <f:then>
                                                    <a href="tel:{registration.phoneNumber}">{registration.phoneNumber}</a>
                                                </f:then>
                                                <f:else>
                                                    <span class="text-muted">-</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                        <td>
                                            <f:switch expression="{registration.status}">
                                                <f:case value="confirmed">
                                                    <span class="badge bg-success">Bestätigt</span>
                                                </f:case>
                                                <f:case value="pending">
                                                    <span class="badge bg-warning">Ausstehend</span>
                                                </f:case>
                                                <f:case value="cancelled">
                                                    <span class="badge bg-danger">Storniert</span>
                                                </f:case>
                                                <f:defaultCase>
                                                    <span class="badge bg-secondary">{registration.status}</span>
                                                </f:defaultCase>
                                            </f:switch>
                                        </td>
                                        <td>
                                            <f:format.date format="d.m.Y H:i">{registration.crdate}</f:format.date>
                                        </td>
                                        <td>
                                            <be:link.editRecord uid="{registration.uid}" table="tx_sitepackage_domain_model_eventregistration" class="btn btn-sm btn-warning">
                                                <f:be.icon identifier="actions-open" />
                                            </be:link.editRecord>
                                        </td>
                                    </tr>
                                </f:for>
                            </tbody>
                        </table>
                    </f:then>
                    <f:else>
                        <div class="alert alert-info mb-0">
                            Noch keine Anmeldungen für dieses Event.
                        </div>
                    </f:else>
                </f:if>
            </div>
        </div>
    </div>
</f:section>
</html>
